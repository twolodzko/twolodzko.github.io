<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2020-11-02">

<title>Tim’s page - Makefiles for not-only programmers</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-V9DH8RH1V5"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-V9DH8RH1V5', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Tim’s page</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/twolodzko"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://bayes.club/@tymwol"><i class="bi bi-mastodon" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Makefiles for not-only programmers</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 2, 2020</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Make is commonly used in software development for managing the compilation of the source code. Use cases of make however go far beyond compiling C code, as it can be used as a tool for writing any kind of command pipeline. While this may be considered heresy by some, Makefiles can be quite useful as a place to store <em>collection of commands to execute</em>, I agree on this with Peter Baumgartner:</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
After using Makefiles on a few DS projects, my advice is: forget everything you've read about them, put <code>SHELL := /bin/bash</code> at the top, and just use it as a place to name and document project-specific shell commands.
</p>
— Peter Baumgartner (<span class="citation" data-cites="pmbaumgartner">@pmbaumgartner</span>) <a href="https://twitter.com/pmbaumgartner/status/1275203940829839363?ref_src=twsrc%5Etfw">June 22, 2020</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>For learning make, there is a great, freely available, book <a href="https://www.oreilly.com/library/view/managing-projects-with/0596006101/"><em>Managing Projects with GNU Make</em></a> by Robert Mecklenburg and <a href="https://www.gnu.org/software/make/manual/make.html">extensive online documentation</a>.</p>
<section id="basics-and-syntax" class="level2">
<h2 class="anchored" data-anchor-id="basics-and-syntax">Basics and syntax</h2>
<p>To use make, you need to define the instructions in the Makefile. The <a href="https://opensource.com/article/18/8/what-how-makefile">syntax for the instructions</a> is</p>
<pre><code>target: prerequisites # comment
&lt;TAB&gt; recipe</code></pre>
<p>where usually the <em>target</em> is a compiled, binary file, <em>recipe</em> is the set of instructions needed for generating the file, and <em>prerequisites</em> are the target names of the other instruction that needs to be run before running the current one. The recipe is just a set of shell instructions.</p>
<p>Using tabs in Makefiles is important, for example, if you used spaces instead of tab, you could see errors like:</p>
<pre class="console"><code>Makefile:3: *** missing separator.  Stop.</code></pre>
</section>
<section id="hello-world" class="level2">
<h2 class="anchored" data-anchor-id="hello-world">Hello World!</h2>
<p>Let’s start with the “Hello World!” example. To run it, you need to install make, and create a file named <em>Makefile</em>, having the following content</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dv">hello:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>   echo <span class="st">"Hello World!"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To run it, go to the directory containing the Makefile and run <code>make hello</code> command from the command line.</p>
</section>
<section id="multi-line-instructions" class="level2">
<h2 class="anchored" data-anchor-id="multi-line-instructions">Multi-line instructions</h2>
<p>The instructions are not limited to single-line ones, they can consist of any number of tab-prefixed lines.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dv">hello:</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>   touch hello</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>   echo <span class="st">"Hello World!"</span> &gt; hello</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>   cat hello</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The example is overly complicated for such a simple task, but it shows how you can define multiple steps to be run sequentially (create an empty file with <code>touch</code>, write “Hello World!” to it using <code>echo</code>, and print it with <code>cat</code>).</p>
</section>
<section id="make-keeps-files-up-to-date" class="level2">
<h2 class="anchored" data-anchor-id="make-keeps-files-up-to-date">Make keeps files up-to-date</h2>
<p>Make always checks if the <em>target</em> file is available, and if this is the case, it doesn’t run the instruction to build it. Moreover, if any of the prerequisites are newer than the target, it re-runs the sequence of instructions. This is helpful when compiling source code stored in multiple files since it keeps the compiled binaries up-to-date with each other.</p>
<p>You can try yourself running the Makefile below. What happens when any of the <code>one</code>, <code>two</code>, <code>three</code>, or <code>four</code> files do not exist? What if they differ in the time of creation? Notice that make will print all the instructions executed. At any time, you can run <code>make clean</code> (don’t bother with its syntax for now) to remove all of the files and start from scratch.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> clean</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="dv">clean:</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> rm -rf one two three four</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="dv">one two:</span><span class="dt"> </span><span class="co"># this one has two targets!</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>   touch one</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>   touch two</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="dv">three:</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>   touch three</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="dv">four:</span><span class="dt"> two three</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>   touch four</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>four</code> target depends on <code>three</code> and <code>two</code>, but not <code>one</code>. So <code>make four</code> checks if <code>four</code> file exists, then it recursively checks its dependencies and their dependencies. Missing files or discrepancies in file save dates invoke commands for creating the file, and all the upstream commands.</p>
</section>
<section id="phony-targets" class="level2">
<h2 class="anchored" data-anchor-id="phony-targets">Phony targets</h2>
<p>I said that <em>target</em> is usually a filename, but this doesn’t have to be the case. Let’s again use the trivial Makefile:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dv">hello:</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>   echo <span class="st">"Hello World!"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If by chance you have the file named <em>hello</em> in the directory containing your Makefile, you would see the following message:</p>
<pre class="console"><code>$ touch hello
$ make
make: 'hello' is up to date.</code></pre>
<p>What make did, is checked that the <code>hello</code> file exists, so it doesn’t need to build it. The above functionality is not relevant when using <a href="https://www.gnu.org/software/make/manual/make.html#Phony-Targets"><em>phony</em> targets</a>, i.e.&nbsp;targets without related files. In such cases, make will display the “strange” messages like above. To disable the check for the target file, you can use the <code>.PHONY</code> variable to list such targets:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> hello</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="dv">hello:</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>   echo <span class="st">"Hello World!"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using phony targets is not that uncommon, for example, you could add instructions like <code>help</code>, to print the help, or <code>clean</code> to clean the working directory from unnecessary files, <code>test</code> to run unit tests, etc.</p>
</section>
<section id="dont-show-the-commands" class="level2">
<h2 class="anchored" data-anchor-id="dont-show-the-commands">Don’t show the commands</h2>
<p>When running the instructions, make by default will print the commands that were invoked, for example when running:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dv">hello:</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>   echo <span class="st">"Hello World!"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>we’ll see the following result:</p>
<pre class="console"><code>$ make hello
echo "Hello World!"
Hello World!</code></pre>
<p>Printing the command can be silenced by adding <code>@</code> at the begging of the line:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dv">silent-hello:</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> echo </span><span class="st">"Hello World!"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>so will only print the result:</p>
<pre class="console"><code>$ make silent-hello
Hello World!</code></pre>
</section>
<section id="using-variables" class="level2">
<h2 class="anchored" data-anchor-id="using-variables">Using variables</h2>
<p>Makefiles can <a href="https://www.gnu.org/software/make/manual/html_node/Using-Variables.html">use variables</a> that can be modified when calling <code>make</code> from the command line. For example, with the following Makefile:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">MESSAGE </span><span class="ch">?=</span><span class="st"> "Hello World!"</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="dv">hello:</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> echo </span><span class="ch">$(</span><span class="dt">MESSAGE</span><span class="ch">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>if <code>MESSAGE</code> is not provided, it prints the default:</p>
<pre class="console"><code>$ make hello
Hello World!</code></pre>
<p>but <a href="https://stackoverflow.com/questions/2826029/passing-additional-variables-from-command-line-to-make">we can provide</a> it either from environment:</p>
<pre class="console"><code>$ MESSAGE="Hi!!!" make hello
Hi!!!</code></pre>
<p>or as a parameter:</p>
<pre class="console"><code>$ make hello MESSAGE="Hi there!"
Hi there!</code></pre>
<p>To set variables, <a href="https://stackoverflow.com/questions/448910/what-is-the-difference-between-the-gnu-makefile-variable-assignments-a">you can</a> use <code>=</code>, <code>:=</code> (simple expansion), <code>?=</code> (set if absent), <code>+=</code> (append). The variables <em>are evaluated at the time of calling <code>make</code></em>, so they do not persist:</p>
<pre class="console"><code>$ make hello MESSAGE="Hi"
Hi
$ make hello MESSAGE="Bye"
Bye
$ make hello
Hello World!</code></pre>
<p>This may be even more obvious with another trivial Makefile:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>TIME <span class="dt">!</span><span class="ch">=</span><span class="st"> date</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="dv">once:</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> echo </span><span class="ch">$(</span><span class="dt">TIME</span><span class="ch">)</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="dv">twice:</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> echo </span><span class="ch">$(</span><span class="dt">TIME</span><span class="ch">)</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> sleep 5s</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> echo </span><span class="ch">$(</span><span class="dt">TIME</span><span class="ch">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Every time you call <code>make once</code>, it will print different times, but calling <code>make twice</code> will print the same time twice, since the <code>TIME</code> variable was evaluated only once per call. The above code uses <code>!=</code> to run the right-hand side code and assign it to the left-hand side variable, alternatively, you could use the <code>shell</code> command to execute the external command:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="dt">TIME </span><span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> date</span><span class="ch">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you need to access environment variables, use the <code>${...}</code> syntax. For example, in Unix system the <code>$USER</code> environment variable holds the username of the currently logged user, so we can access it with:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dv">who:</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> echo </span><span class="ch">${</span><span class="dt">USER</span><span class="ch">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="macros" class="level2">
<h2 class="anchored" data-anchor-id="macros">Macros</h2>
<p>Besides variables, make supports <a href="https://www.oreilly.com/library/view/managing-projects-with/0596006101/ch03.html">macros</a>. Macro can be a set of commands, for example:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> commands</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> echo </span><span class="st">"Hello!"</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> echo </span><span class="st">"It's </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> date</span><span class="ch">)</span><span class="st">"</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="kw">endef</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="dv">default:</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>   <span class="ch">$(</span><span class="dt">commands</span><span class="ch">)</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> echo </span><span class="st">"Bye!"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Another usage may be to “paste” the parameters into a command:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> tz</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>   <span class="ch">-</span><span class="fu">-utc </span><span class="ch">\</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">   </span><span class="st">'+%Y-%m-%d %H:%M:%s %Z'</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">endef</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="dv">utctime:</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>   date <span class="ch">$(</span><span class="dt">tz</span><span class="ch">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This may be useful if we repeat some commands, or parameters in the code, and do not want to repeat ourselves.</p>
</section>
<section id="conditional-statements" class="level2">
<h2 class="anchored" data-anchor-id="conditional-statements">Conditional statements</h2>
<p>Make supports <a href="https://www.gnu.org/software/make/manual/html_node/Conditional-Syntax.html">conditional</a> statements: <code>ifeq</code>, <code>ifneq</code>, <code>ifdef</code>, and <code>ifndef</code>. The tricky part is that the statements are not indented, so the formatting needs to be:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">COND </span><span class="ch">?=</span><span class="st"> false</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="dv">default:</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> <span class="st">"</span><span class="ch">$(</span><span class="dt">COND</span><span class="ch">)</span><span class="st">"</span> <span class="st">"true"</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> echo </span><span class="st">"It's true"</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> echo </span><span class="st">"It's false"</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="self-documenting-the-makefile" class="level2">
<h2 class="anchored" data-anchor-id="self-documenting-the-makefile">Self-documenting the Makefile</h2>
<p>It is useful to provide the user with some kind of documentation of what are the functionalities of make. While there is no build-in solution for that, it can be easily achieved with Makefile comments. A simple and useful solution was described in a <a href="https://marmelab.com/blog/2016/02/29/auto-documented-makefile.html">blog post by François Zaninotto</a>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="dv">hello:</span><span class="dt"> </span><span class="co">## Say hello</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>   echo <span class="st">"Hello World!"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="dv">help:</span><span class="dt"> </span><span class="co">## Print help</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>   <span class="ch">@</span><span class="fu"> grep -E </span><span class="st">'^[a-zA-Z_-]+:.*?## .*</span><span class="ch">$$</span><span class="st">'</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">MAKEFILE_LIST</span><span class="ch">)</span><span class="fu"> | sort | awk </span><span class="st">'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", </span><span class="ch">$$</span><span class="st">1, </span><span class="ch">$$</span><span class="st">2}'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As you can see, it assumes that the documentation is prefixed with the <code>##</code> signs, and prints those lines if your calls <code>make help</code>. In some cases, it might be useful to set <code>help</code> as a default goal, by making it the first instruction, or by setting <code>.DEFAULT_GOAL := help</code>.</p>
</section>
<section id="other-uses-of-make" class="level2">
<h2 class="anchored" data-anchor-id="other-uses-of-make">Other uses of make</h2>
<p>Makefiles are useful for <a href="https://www.docker.com/blog/containerizing-test-tooling-creating-your-dockerfile-and-makefile/">using together with docker</a>, so instead of needing the user to run the necessary commands by hand, you can provide them <a href="https://itnext.io/docker-makefile-x-ops-sharing-infra-as-code-parts-ea6fa0d22946">with ready recipes</a>.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dt">REPO </span><span class="ch">?=</span><span class="st"> my-repository</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="dt">TAG </span><span class="ch">?=</span><span class="st"> my-image-0.1</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="dt">IMAGE </span><span class="ch">?=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">REPO</span><span class="ch">)</span><span class="st">:</span><span class="ch">$(</span><span class="dt">TAG</span><span class="ch">)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> image push build</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="dv">build:</span><span class="dt"> image push</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="dv">image:</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>   docker build -t <span class="ch">$(</span><span class="dt">IMAGE</span><span class="ch">)</span> -f Dockerfile .</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="dv">push:</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>   docker push <span class="ch">$(</span><span class="dt">IMAGE</span><span class="ch">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Make can be used also for <a href="https://medium.com/@davidstevens_16424/make-my-day-ta-science-easier-e16bc50e719c">many other tasks</a> like setting up Python environments, running unit tests and linters for the code, making API calls, <a href="https://medium.com/nubego/how-to-run-terraform-like-a-pro-in-a-devops-world-c21458ba402c">running Terraform</a> to setup cloud-based architecture, and other tasks that need to be run repeatably, or by different users.</p>
<p>It can be used also for data science projects, where we are interested in building pipelines that download the data, preprocess it, do feature engineering, train the model, validate the results, save them, etc., as described by <a href="http://zmjones.com/make/">Zachary M. Jones</a>, <a href="https://robjhyndman.com/hyndsight/makefiles/">Rob J. Hyndman</a>, <a href="https://blog.sellorm.com/2018/06/02/first-steps-with-data-pipelines/">Mark Sellors</a>, <a href="https://bost.ocks.org/mike/make/">Mike Bostock</a>, <a href="https://byronjsmith.com/make-bml/">Byron J. Smith</a>, <a href="https://stat545.com/automating-pipeline.html">Jenny Bryan</a>, and others.</p>
</section>
<section id="change-the-defaults" class="level2">
<h2 class="anchored" data-anchor-id="change-the-defaults">Change the defaults</h2>
<p>By default, instructions in Makefile assume using <a href="https://unix.stackexchange.com/questions/217243/which-shell-is-used-in-gnu-make-files"><code>sh</code> as default shell</a>, however <a href="https://askubuntu.com/questions/141928/what-is-the-difference-between-bin-sh-and-bin-bash"><code>/bin/sh</code> is just a symbolic link, that in different systems can point to different shells</a>, so for consistency, it might be worth to <a href="https://tech.davis-hansson.com/p/make/">change</a> the <code>SHELL</code> <a href="#using-variables">variable</a>, e.g.&nbsp;to <code>SHELL=bash</code>.</p>
<p>Some <a href="https://tech.davis-hansson.com/p/make/">other useful defaults</a> include using “strict” mode in bash <code>.SHELLFLAGS := -eu -o pipefail -c</code>, or forcing make to check the Makefile for unused variables and turning off the <a href="https://www.gnu.org/software/make/manual/html_node/Catalogue-of-Rules.html">automatic rules</a> written for parsing source code files:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode makefile code-with-copy"><code class="sourceCode makefile"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dt">MAKEFLAGS </span><span class="ch">+=</span><span class="st"> --warn-undefined-variables</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="dt">MAKEFLAGS </span><span class="ch">+=</span><span class="st"> --no-builtin-rules</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="https://stackoverflow.com/questions/2131213/can-you-make-valid-makefiles-without-tab-characters">In newer versions of make</a> you can switch from using tabs for indenting the instructions by setting the <code>.RECIPEPREFIX</code> <a href="#using-variables">variable</a>, though it is probably easier to stick to tabs when using make.</p>
<p>If you want to change the default make goal, so that <code>make</code> invokes other than the first recipe in the Makefile, set <code>.DEFAULT_GOAL</code> variable to the name of the desired instruction.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>